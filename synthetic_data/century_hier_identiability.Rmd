---
title: "Hierarchical Bayesian Modeling of CO2 Flux"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Introduction

In this document, we study synthetic soil Carbon data generated by the century model. Each flux data has several replicates, corresponding to different incubation test done on the soil from the same sample. We consider a hierarchical Bayesian model, and examine the estimates as (i) the amount of input data is increased, and (ii) the parameter priors get stronger.  

## Century Model

The century model is proposed by Parton et al. (1988). We only focus on the three soil pools in this model which are listed below along with their expert-tuned decomposition rates:

\begin{itemize}
\item[pool 1:] \makebox[2.5cm]{Active Soil C,\hfill}  $\kappa_1 \approx 1/1.5$,
\item[pool 2:] \makebox[2.5cm]{Slow Soil C,\hfill} $\kappa_2 \approx 1/25$,
\item[pool 3:] \makebox[2.5cm]{Passive Soil C,\hfill}  $\kappa_3 \approx 1/1000$,
\end{itemize}
where $\kappa$ denotes the decay rate which is defined as 1 over the turnover. 

We denote the transfer rate from pool $j$ to pool $i$ by $r_{ij}$. The transfer rates are parameterized as a ratio of the decay rate: $r_{ij} = \alpha_{ij} \kappa_j$. For the Century model, we have:
\begin{align*}
\alpha_{21} & = 1 - F(\text{T}) - 0.004, \\
\alpha_{31} & = 0.004, \\
\alpha_{12} & = 0.42, \\
\alpha_{32} & = 0.03, \\
\alpha_{13} & = 0.45, \\
\alpha_{23} & = 0,
\end{align*}
where `T' is the soil silt + clay content, and $F(\text{T}) = 0.85 - 0.68 \times \text{T}$. These values are expert-tuned; however, in our Bayesian framework, we estimate them from the data. For each pool, we can write the following differential equation:
\begin{equation*}
\frac{d C_i(t)}{dt} = -\kappa_i C_i(t) + \sum_{j\neq i} \alpha_{ij} \kappa_j.
\end{equation*}
Combining all these differential equations into a single formula, we get:
\begin{equation*}
\frac{dC(t)}{dt} = 
   \left( {\begin{array}{ccc}
   -\kappa_1 & \alpha_{12} \kappa_2 & \alpha_{13}\kappa_3 \\
    \alpha_{21}\kappa_1 & -\kappa_2& 0  \\
    \alpha_{31} \kappa_1 & \alpha_{32} \kappa_2 & -\kappa_3    
   \end{array} } \right) C(t).
\end{equation*}

The total amount of Carbon in the beginning is $C_{tot}$ which is divided among the three pools: $C(0) = (\gamma_1, \gamma_2, \gamma_3) \cdot C_{tot}$. 

## Simulating Synthetic Data 

We simulate data according to the century model. Before presenting the `R` code, we need to clarify some details.  

### CO$_2$ flux, sampling times, and cap times

We assume that our observations are in terms of CO$_2$ fluxes. Theoretically, the CO$_2$ flux at time $t$ is defined as $\sum_{i=1}^3 |{dC_i(t)}/{dt}|$, i.e., the rate of CO$_2$ leaving the soil. In experiments, this is calculated by measuring the CO$_2$ emitted between a cap time, $t_{cap}$, and a measurement time, $t_{meas}$: 
$$\text{flux}(t_{meas}) = {\Delta CO_2}/(t_{meas} - t_{cap})$$. 

Generally, the sampling times are not uniform. The CO$_2$ flux is sampled more frequently in the beginning. A common practice is to sample once per day for the first week, then once per week for the first month, and then once per month. Given that the scale of the turnover rates are in years, this amounts to the following measurement times:
$$t_{meas} = (\frac{1}{360}, \frac{2}{360}, \frac{3}{360}, \frac{4}{360}, \frac{5}{360}, \frac{6}{360}, \frac{7}{360}, \frac{14}{360}, \frac{21}{360}, \frac{28}{360}, \frac{60}{360}, \frac{90}{360}, \frac{120}{360}, \ldots, \frac{360}{360}) 
$$
The cap times might vary in different experiments. Here, we assume that the cap times are halfway between previous and current measurements:
$$t_{cap} = (\frac{0.5}{360}, \frac{1.5}{360}, \frac{2.5}{360}, \frac{3.5}{360}, \frac{4.5}{360}, \frac{5.5}{360}, \frac{6.5}{360}, \frac{10.5}{360}, \frac{17.5}{360}, \frac{24.5}{360}, \frac{45}{360}, \frac{75}{360}, \frac{105}{360}, \ldots, \frac{345}{360}) 
$$

One of the goals of this report to increase the number of data points and examine the corresponding fits. 


### Replications

Generally, we have several replications for each experiment (i.e., several CO$_2$ fluxes). We assume that these replications differ slightly in the transfer rates but have the same $\gamma$ and turnover rates (given that they are from the same soil sample). The way we model the variation in the turnover rates is through a hirarchical Dirichlet model. The vector $(\alpha_{1j}^i, \alpha_{2j}^i, \alpha_{3j}^i)$ is a simplex. The superscript $i$ refers to the $i$'th replicate and index $j$ refers to the $j$'th pool. We assume that there are global simplex vectors $(\alpha_{1j}^0, \alpha_{2j}^0, \alpha_{3j}^0)$ such that we have the following hierarchical structure:
$$
(\alpha_{1j}^0, \alpha_{2j}^0, \alpha_{3j}^0) \sim \text{Dirichlet}(1,1,1), \\
(\alpha_{1j}^i, \alpha_{2j}^i, \alpha_{3j}^i) \sim \text{Dirichlet}(\kappa \times (\alpha_{1j}^0, \alpha_{2j}^0, \alpha_{3j}^0)),
$$
where $\kappa\sim\text{Pareto}(1, 1.5)$. 

### R code

The R function for simulating the data is shown below. The details are described above.
```{r simulate}
simulate_data_century <- function(t_meas, t_cap, init_C, num_rep) {
# INPUTS: 
#   t_meas:  measurement times
#   t_cap:   cap times
#   init_C:  initial pool contents
#   num_rep: number of replications
library(deSolve)
library(gtools)
genDerivs <-function(t, Ct, params) {
  # General diff eq model: dC_dt = I(t) + A(t)*C(t)
  # INPUTS:
  #   t: time
  #   Ct: the value of the vector C at time t, C(t)
  #   params: it has two fields, params$I and params$A
  dC_dt = params$I + params$A %*% Ct;
  return(list(dC_dt));
}
m <- 3; # number of pools
C_t0 <- matrix(init_C, nrow=m);
turnover <- c(1.5, 25, 1000);
K <- 1/turnover;
I <- rep(0, m); # no input flux for century
N_t <- length(t_meas);
CO2_flux_mat <- matrix(NA, nrow = N_t, ncol = num_rep);
Alpha_rep <- array(0, c(m, m, num_rep));
Alpha <- matrix(0, m, m);
# Setting global transfer rates with expert-tuned values:
Alpha[2, 1] = 0.5;
Alpha[3, 1] = 0.004;
Alpha[1, 2] = 0.42;
Alpha[3, 2] = 0.03;
Alpha[1, 3] = 0.45;
Alpha[1, 1] = 1 - Alpha[2, 1] - Alpha[3, 1];
Alpha[2, 2] = 1 - Alpha[1, 2] - Alpha[3, 2];
Alpha[3, 3] = 1 - Alpha[1, 3] - Alpha[2, 3];
for (this_rep in 1:num_rep) {
  # Hierarchical modeling of transfer rates for replications:
  kappa <- 10;
  Alpha_rep[,1, this_rep] <-  rdirichlet(1, Alpha[,1] * kappa);
  Alpha_rep[,2, this_rep] <-  rdirichlet(1, Alpha[,2] * kappa);
  Alpha_rep[,3, this_rep] <-  rdirichlet(1, Alpha[,3] * kappa);
  Alpha_rep[1, 1, this_rep] <- 0;
  Alpha_rep[2, 2, this_rep] <- 0;
  Alpha_rep[3, 3, this_rep] <- 0;
  A <- Alpha_rep[,, this_rep] * matrix(rep(K, m), nrow = m, byrow = TRUE) - diag(K);
  params <- list(I=I, A=A);
  t0 <- 0;
  # Solving the ODE system for given parameters:
  meas_data<-ode(y = C_t0, func = genDerivs,
          times = c(t0,t_meas), parms = params);
  cap_data<-ode(y = C_t0, func = genDerivs,
                 times = c(t0,t_cap), parms = params);
  # Calculating CO2 flux 
  totalC_t0 = sum(meas_data[1,2:(m+1)]);
  CO2_t_meas <- totalC_t0 - rowSums(meas_data[2:nrow(meas_data), 2:(m+1)]);
  CO2_t_cap <- totalC_t0 - rowSums(cap_data[2:nrow(cap_data),2:(m+1)]);
  CO2_flux <- (CO2_t_meas - CO2_t_cap)/(t_meas-t_cap); 
  # Adding log-normal noise:
  CO2_flux_mat[, this_rep] <- exp(log(CO2_flux) + rnorm(length(CO2_flux),0,.05));
}
simulated_data <- list(N_t = N_t, t_meas = t_meas, t_cap = t_cap, 
                       num_rep = num_rep, totalC_t0 = totalC_t0,
                       t0=t0, CO2_flux=CO2_flux_mat, Alpha_rep=Alpha_rep);
return(simulated_data);
}
```

## Stan code

```{r, echo=FALSE, comment=NA}
file_path <- "century_hier_nonstiff.stan";
lines <- readLines(file_path, encoding="ASCII");
for (n in 1:length(lines)) cat(lines[n],'\n');
```

## Fitting models

```{r fit, message=FALSE, warning=FALSE, cache=TRUE}
t_meas <- c(seq(from=1/360, to=7/360, by=0.1*1/360), seq(from=8/360, to=28/360, by=0.1*7/360),
            seq(from=30/360, to=360/360, by=0.1*30/360));
t_cap <- c(0.5/360, (head(t_meas,-1)+tail(t_meas,-1))/2)
init_C <- c(10, 10, 80);
num_rep <- 5;
data <- simulate_data_century(t_meas, t_cap, init_C, num_rep);
library(rstan);
library(tictoc);
rstan_options(auto_write = TRUE);
options(mc.cores = parallel::detectCores());
sm <- stan_model("century_hier_nonstiff.stan")
fit_all_data<-sampling(sm, data=data, iter=15, seed=1234);
saveRDS(fit_all_data,"all_data.rds")
half_data <- simulate_data_century(t_meas[seq(1,length(t_meas),2)], 
                                   t_cap[seq(1,length(t_meas),2)], init_C, num_rep);
fit_half_data<-sampling(sm, data=half_data, iter=15, seed=1234);
saveRDS(fit_half_data,"half_data.rds")
quarter_data <- simulate_data_century(t_meas[seq(1,length(t_meas),4)],
                                      t_cap[seq(1,length(t_meas),4)], init_C, num_rep);
fit_quarter_data<-sampling(sm, data=quarter_data, iter=15, seed=1234);
saveRDS(fit_quarter_data,"quarter_data.rds")
tenth_data <- simulate_data_century(t_meas[seq(1,length(t_meas),10)],
                                      t_cap[seq(1,length(t_meas),10)], init_C, num_rep);
fit_tenth_data<-sampling(sm, data=tenth_data, iter=15, seed=1234);
saveRDS(fit_tenth_data,"tenth_data.rds")
```
